<?php/** * $Author: p p@lansehangxian.com * $Date: 2019-01-17 * 编辑器文件上传相关，远程下载文件整合与xheditor * blueblog.lansehangxian.com*/if ($_GET['remote_copy']==1){	$arrUrls=explode('|',$_POST['urls']);	$urlCount=count($arrUrls);	for($i=0;$i<$urlCount;$i++)	{		if(substr($arrUrls[$i],0,10)=='data:image')		{			//base64编码的图片，可能出现在firefox粘贴，或者某些网站上，例如google图片			if(preg_match('/^data:image\/(jpg|jpeg|gif|png)/i',$arrUrls[$i],$sExt))			{				$sExt=$sExt[1];				$imgContent=base64_decode(substr($arrUrls[$i],strpos($arrUrls[$i],'base64,')+7));			}		}		else		{			if(preg_match('/\.(jpg|jpeg|gif|png)$/i',$arrUrls[$i],$sExt))			{				$sExt=$sExt[1];				$imgContent=getUrl($arrUrls[$i]);			}		}		$file_name=time().rand(10000,60000).'.'.$sExt;			$dir=LSHX_BLOG_ROOT.'home/upload/'.date('Y-m').'/';			$url_dir='home/upload/'.date('Y-m').'/';			//文件按照月份存档，如果不存在该目录则创建该目录			if (!is_dir($dir))			{				@mkdir($dir,0777);				@fclose(fopen($dir.'/index.htm', 'w'));			}			$u=str_replace(LSHX_BLOG_WS_ADMIN, '', dirname($url));			$url_name=$u.$url_dir.$file_name;			$file_name=$dir.$file_name;			file_put_contents($file_name,$imgContent);		$sql="INSERT INTO  ".table('attachments')." (`attachment_id` ,`file_name` ,`type`,`add_time`)VALUES (NULL ,  '$url_name',  '".$_GET['type']."',  '".time()."' )";		$master_db?$db2->query($sql):$db->query($sql);		$arrUrls[$i]=$url_name;	}	echo implode('|',$arrUrls);}else{	require(ROOT.'/includes/upload.'.'html5.class.php');	$file=new cls_upload();    reset ($_FILES);    $uoload = current($_FILES);	$file_name=$file->upload($uoload,$_GET['type']);	$file_url='';	if ($file->error()=='')	{		$sql="INSERT INTO  ".table('attachments')." (`attachment_id` ,`file_name` ,`type`,`add_time`)VALUES (NULL ,  '$file_name',  '".$_GET['type']."',  '".time()."' )";		$master_db?$db2->query($sql):$db->query($sql);		$u=str_replace(LSHX_BLOG_WS_ADMIN, '', dirname($url));		if ($_GET['type']=='img')		{		    $file_url=$u.$file_name;		}		else {		    $file_url=$u.'attachment.php?fid='.$db->insert_id();		}        echo json_encode(array('location' => $file_url));		exit;    }	else    {        header('Content-Type: text/html; charset=UTF-8');        $str='{"err":"'.$file->error().'","msg":"'.$file_url.'"}';        exit($str);    }}//抓URL数据function getUrl($sUrl,$jumpNums=0){	if (SLSYS=='SAE')	{		$f = new SaeFetchurl();		$content = $f->fetch($sUrl);		return $content;	}	else	{		$arrUrl = parse_url(trim($sUrl));		if(!$arrUrl)return false;		$host=$arrUrl['host'];		$port=isset($arrUrl['port'])?$arrUrl['port']:80;		$path=$arrUrl['path'].(isset($arrUrl['query'])?"?".$arrUrl['query']:"");		$fp = @fsockopen($host,$port,$errno, $errstr, 30);		if(!$fp)return false;		$output="GET $path HTTP/1.0\r\nHost: $host\r\nReferer: $sUrl\r\nConnection: close\r\n\r\n";		stream_set_timeout($fp, 60);		@fputs($fp,$output);		$Content='';		while(!feof($fp))		{			$buffer = fgets($fp, 4096);			$info = stream_get_meta_data($fp);			if($info['timed_out'])return false;			$Content.=$buffer;		}		@fclose($fp);		global $jumpCount;//重定向		if(preg_match("/^HTTP\/\d.\d (301|302)/is",$Content)&&$jumpNums<5)		{			if(preg_match("/Location:(.*?)\r\n/is",$Content,$murl))return getUrl($murl[1],$jumpNums+1);		}		if(!preg_match("/^HTTP\/\d.\d 200/is", $Content))return false;		$Content=explode("\r\n\r\n",$Content,2);		$Content=$Content[1];		if($Content)return $Content;		else return false;	}}?>